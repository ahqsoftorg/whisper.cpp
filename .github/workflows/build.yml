name: Build whisper.cpp

on:
  push:
  schedule:
    - cron: "0 0 1 * *"

permissions: write-all

jobs:
  matrix:
    outputs:
      matrix: ${{ steps.matrices.outputs.result }}

    name: Generate Matrix

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Generate Matrices
        uses: actions/github-script@v8
        id: matrices
        with:
          script: |
            const out = require("./matrix.cjs");

            return out();

  build:
    needs: [matrix]

    name: ${{ matrix.name }}

    runs-on: ${{ matrix.runner }}

    continue-on-error: true

    strategy:
      fail-fast: false

      matrix:
        include: ${{ fromJson(needs.matrix.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Clone whisper.cpp
        run: git clone https://github.com/ggml-org/whisper.cpp.git

      - name: Build Whisper
        shell: pwsh
        run: |
          cmake -B build -D CMAKE_INSTALL_PREFIX="${{github.workspace}}/build" -D WHISPER_BUILD_EXAMPLES=OFF -D WHISPER_BUILD_TESTS=OFF -D WHISPER_BUILD_SERVER=OFF -D CMAKE_BUILD_TYPE=Release ${{ matrix.flags }}

          ../activex.ps1

          Compress-Archive -Path ${{ github.workspace }}/build/lib/* -DestinationPath ${{ github.workspace }}\whisper-cpp-${{ matrix.os }}${{ matrix.suffix }}.zip
        working-directory: whisper.cpp
        env:
          OS: ${{ matrix.os }}

      - name: Upload
        uses: actions/upload-artifact@v5
        with:
          path: |
            ./*.zip
          name: whisper-cpp-${{ matrix.os }}${{ matrix.suffix }}

  release:
    needs: [build]

    name: Create release
    runs-on: ubuntu-latest

    permissions: write-all

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v5

      - name: Get Tag
        uses: actions/github-script@v8
        id: tag
        with:
          result-encoding: string
          script: |
            return require("./release.cjs");

      - name: Download
        uses: actions/download-artifact@v5
        with:
          merge-multiple: true

      - name: Release
        id: data
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.result }}
          draft: true
          body: |
            # Binaries
          files: |
            *.zip

      - name: Models + Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.tag.outputs.result }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          curl https://raw.githubusercontent.com/ggml-org/whisper.cpp/refs/heads/master/models/download-ggml-model.sh > downloadmodel.sh
          chmod +x downloadmodel.sh

          models="tiny
          tiny.en
          tiny-q5_1
          tiny.en-q5_1
          tiny-q8_0
          base
          base.en
          base-q5_1
          base.en-q5_1
          base-q8_0
          small
          small.en
          small-q5_1
          small.en-q5_1
          small-q8_0
          medium
          medium.en
          medium-q5_0
          medium.en-q5_0
          medium-q8_0
          large-v1
          large-v2
          large-v2-q5_0
          large-v2-q8_0
          large-v3
          large-v3-q5_0
          large-v3-turbo
          large-v3-turbo-q5_0
          large-v3-turbo-q8_0"

          for model in $models; do
            ASSET="ggml-$model.bin"

            ./downloadmodel.sh "$model"

            gh release upload "$TAG" "$ASSET" \
              --repo "$GITHUB_REPOSITORY" \
              --clobber

            rm "$ASSET"
          done

          gh release edit "$TAG" --draft=false
